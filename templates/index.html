<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACCS - AI Film Intelligence Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .header {
            background: rgba(0,0,0,0.3);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .logo span {
            color: #48bb78;
        }
        
        .stats-bar {
            display: flex;
            gap: 30px;
            font-size: 0.9em;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #48bb78;
        }
        
        .main-content {
            padding: 30px 40px;
        }
        
        .films-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .film-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            color: #1a365d;
            position: relative;
        }
        
        .film-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1a365d;
        }
        
        .film-meta {
            font-size: 0.85em;
            color: #718096;
            margin-bottom: 12px;
        }
        
        .film-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .tag {
            background: #e2e8f0;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            color: #4a5568;
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #2c5282, #1a365d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .analysis-result {
            display: none;
            margin-top: 15px;
            background: linear-gradient(135deg, #f0fff4, #c6f6d5);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        .analysis-result.show {
            display: block;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e53e3e;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .close-btn:hover {
            background: #c53030;
        }
        
        .score-display {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .score-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #276749;
        }
        
        .pathway-badge {
            background: #276749;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .tab {
            background: #276749;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }
        
        .tab:hover, .tab.active {
            background: #22543d;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .prediction-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .prediction-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #276749;
        }
        
        .prediction-label {
            font-size: 0.8em;
            color: #718096;
        }
        
        .view-report-btn {
            background: #2c5282;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .view-report-btn:hover {
            background: #1a365d;
        }
        
        .ranking-content, .revenue-content, .matches-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            color: #1a365d;
        }
        
        .ranking-item, .match-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .ranking-item:last-child, .match-item:last-child {
            border-bottom: none;
        }
        
        .match-score {
            background: #48bb78;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.85em;
        }
        
        .revenue-range {
            font-size: 1.5em;
            font-weight: bold;
            color: #276749;
            text-align: center;
            padding: 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #276749;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
        }
        
        .filter-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üé¨ <span>PACCS</span></div>
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="totalFilms">0</div>
                <div>Films</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="analyzedFilms">0</div>
                <div>Analyzed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="avgScore">0</div>
                <div>Avg Score</div>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Search films..." id="searchInput" onkeyup="filterFilms()">
            <button class="filter-btn" onclick="loadFilms()">üîÑ Refresh</button>
        </div>
        
        <div class="films-grid" id="filmsGrid">
            <!-- Films will be loaded here -->
        </div>
    </div>

    <script>
        let filmsData = [];
        
        async function loadFilms() {
            try {
                const response = await fetch('/api/films');
                const data = await response.json();
                filmsData = data.films || [];
                renderFilms(filmsData);
                updateStats(data);
            } catch (error) {
                console.error('Error loading films:', error);
            }
        }
        
        function updateStats(data) {
            document.getElementById('totalFilms').textContent = data.total || 0;
            document.getElementById('analyzedFilms').textContent = data.analyzed || 0;
            document.getElementById('avgScore').textContent = data.avg_score ? data.avg_score.toFixed(1) : '0';
        }
        
        function renderFilms(films) {
            const grid = document.getElementById('filmsGrid');
            grid.innerHTML = '';
            
            films.slice(0, 50).forEach((film, index) => {
                const card = document.createElement('div');
                card.className = 'film-card';
                card.innerHTML = `
                    <div class="film-title">${film.title || 'Untitled'}</div>
                    <div class="film-meta">${film.duration || '?'} min | ${film.country || 'Unknown'} | </div>
                    <div class="film-tags">
                        <span class="tag">${film.genre || 'General'}</span>
                        <span class="tag">${film.themes || 'General'}</span>
                    </div>
                    <button class="analyze-btn" onclick="analyzeFilm(${index}, this)">
                        üîç Analyze Film
                    </button>
                    <div class="loading" id="loading-${index}">
                        <div class="spinner"></div>
                        <div>Analyzing with AI agents...</div>
                    </div>
                    <div class="analysis-result" id="result-${index}">
                        <button class="close-btn" onclick="closeAnalysis(${index})">‚úï</button>
                        <div class="score-display">
                            <div class="score-number" id="score-${index}">-</div>
                            <div class="pathway-badge" id="pathway-${index}">-</div>
                        </div>
                        <div class="tabs">
                            <button class="tab active" onclick="showTab(${index}, 'predictions')">üìä Predictions</button>
                            <button class="tab" onclick="showTab(${index}, 'ranking')">üìà Ranking</button>
                            <button class="tab" onclick="showTab(${index}, 'revenue')">üí∞ Revenue</button>
                            <button class="tab" onclick="showTab(${index}, 'matches')">üéØ Matches</button>
                        </div>
                        <div class="tab-content active" id="predictions-${index}">
                            <div class="predictions-grid">
                                <div class="prediction-box">
                                    <div class="prediction-value" id="festival-${index}">-</div>
                                    <div class="prediction-label">Festival Selection</div>
                                </div>
                                <div class="prediction-box">
                                    <div class="prediction-value" id="distribution-${index}">-</div>
                                    <div class="prediction-label">Distribution Deal</div>
                                </div>
                                <div class="prediction-box">
                                    <div class="prediction-value" id="award-${index}">-</div>
                                    <div class="prediction-label">Award Nomination</div>
                                </div>
                                <div class="prediction-box">
                                    <div class="prediction-value" id="viral-${index}">-</div>
                                    <div class="prediction-label">Viral Potential</div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-content" id="ranking-${index}">
                            <div class="ranking-content" id="ranking-content-${index}">
                                Loading...
                            </div>
                        </div>
                        <div class="tab-content" id="revenue-${index}">
                            <div class="revenue-content" id="revenue-content-${index}">
                                Loading...
                            </div>
                        </div>
                        <div class="tab-content" id="matches-${index}">
                            <div class="matches-content" id="matches-content-${index}">
                                Loading...
                            </div>
                        </div>
                        <button class="view-report-btn" onclick="viewReport(${index})">
                            üìÑ View Full Report
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function filterFilms() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = filmsData.filter(film => 
                (film.title && film.title.toLowerCase().includes(search)) ||
                (film.country && film.country.toLowerCase().includes(search)) ||
                (film.genre && film.genre.toLowerCase().includes(search))
            );
            renderFilms(filtered);
        }
        
        async function analyzeFilm(index, btn) {
            const loading = document.getElementById(`loading-${index}`);
            const result = document.getElementById(`result-${index}`);
            
            btn.style.display = 'none';
            loading.classList.add('show');
            
            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ film_index: index })
                });
                
                const data = await response.json();
                
                loading.classList.remove('show');
                result.classList.add('show');
                
                // Update score and pathway
                document.getElementById(`score-${index}`).textContent = 
                    (data.final_score || data.score || 0).toFixed(1) + '/10';
                document.getElementById(`pathway-${index}`).textContent = 
                    data.pathway || 'FESTIVAL';
                
                // Update predictions
                const pred = data.success_prediction || {};
                document.getElementById(`festival-${index}`).textContent = 
                    (pred.festival_selection || 50) + '%';
                document.getElementById(`distribution-${index}`).textContent = 
                    (pred.distribution_deal || 30) + '%';
                document.getElementById(`award-${index}`).textContent = 
                    (pred.award_nomination || 10) + '%';
                document.getElementById(`viral-${index}`).textContent = 
                    (pred.viral_potential || 5) + '%';
                
                // Update ranking
                const comp = data.comparison || {};
                const overall = comp.overall || {};
                document.getElementById(`ranking-content-${index}`).innerHTML = `
                    <div class="ranking-item">
                        <span>Overall Ranking</span>
                        <span>Top ${100 - (overall.percentile || 50)}%</span>
                    </div>
                    <div class="ranking-item">
                        <span>Genre Ranking</span>
                        <span>Top ${100 - ((comp.genre || {}).percentile || 50)}%</span>
                    </div>
                    <div class="ranking-item">
                        <span>Quality Score</span>
                        <span>${((data.quality_assessment || {}).score || 7).toFixed(1)}/10</span>
                    </div>
                    <div class="ranking-item">
                        <span>Market Score</span>
                        <span>${((data.market_assessment || {}).score || 7).toFixed(1)}/10</span>
                    </div>
                `;
                
                // Update revenue
                const rev = data.revenue_estimate || {};
                document.getElementById(`revenue-content-${index}`).innerHTML = `
                    <div class="revenue-range">¬£${(rev.low_estimate || 1000).toLocaleString()} - ¬£${(rev.high_estimate || 5000).toLocaleString()}</div>
                    <div style="text-align: center; color: #718096; font-size: 0.85em;">Estimated Market Value</div>
                `;
                
                // Update matches
                const festivals = data.festival_matches || [];
                const distributors = data.distributor_matches || [];
                let matchesHTML = '<strong>Top Festival Matches:</strong><br>';
                festivals.slice(0, 3).forEach(f => {
                    matchesHTML += `<div class="match-item"><span>${f.name}</span><span class="match-score">${f.match_score}%</span></div>`;
                });
                matchesHTML += '<br><strong>Top Distributor Matches:</strong><br>';
                distributors.slice(0, 3).forEach(d => {
                    matchesHTML += `<div class="match-item"><span>${d.name}</span><span class="match-score">${d.match_score}%</span></div>`;
                });
                document.getElementById(`matches-content-${index}`).innerHTML = matchesHTML;
                
                // Store data for report
                window[`filmData-${index}`] = data;
                
            } catch (error) {
                console.error('Error:', error);
                loading.classList.remove('show');
                btn.style.display = 'flex';
                alert('Error analyzing film. Please try again.');
            }
        }
        
        function closeAnalysis(index) {
            const result = document.getElementById(`result-${index}`);
            const btn = result.parentElement.querySelector('.analyze-btn');
            result.classList.remove('show');
            btn.style.display = 'flex';
        }
        
        function showTab(index, tabName) {
            // Hide all tabs
            document.querySelectorAll(`#result-${index} .tab-content`).forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`#result-${index} .tab`).forEach(t => t.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(`${tabName}-${index}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        function viewReport(index) {
            const data = window[`filmData-${index}`];
            if (data && data.film_id) {
                window.open(`/api/report/${data.film_id}/pdf`, '_blank');
            } else {
                alert('Please analyze the film first.');
            }
        }
        
        // Load films on page load
        loadFilms();
    </script>
</body>
</html>