<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Marketplace - PACCS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5em; font-weight: bold; color: #fff; text-decoration: none; }
        .logo span { color: #a855f7; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { color: rgba(255,255,255,0.8); text-decoration: none; padding: 8px 16px; border-radius: 20px; }
        .nav-links a:hover { background: rgba(255,255,255,0.1); }
        .hero { background: linear-gradient(135deg, #1a1a2e 0%, #2d1f3d 100%); padding: 60px 40px; text-align: center; }
        .hero h1 { font-size: 3em; margin-bottom: 15px; }
        .hero h1 span { color: #22c55e; }
        .hero p { color: rgba(255,255,255,0.7); font-size: 1.1em; max-width: 600px; margin: 0 auto 30px; }
        .search-bar { max-width: 600px; margin: 0 auto; display: flex; gap: 10px; }
        .search-bar input { flex: 1; padding: 15px 20px; border-radius: 25px; border: 2px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1em; }
        .search-bar input:focus { outline: none; border-color: #22c55e; }
        .search-bar button { padding: 15px 25px; border-radius: 25px; border: none; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; font-weight: 600; cursor: pointer; }
        .filters { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: white; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover, .filter-btn.active { background: rgba(34,197,94,0.2); border-color: #22c55e; color: #22c55e; }
        .main-content { max-width: 1200px; margin: 0 auto; padding: 40px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .section-header h2 { font-size: 1.6em; }
        .tracks-grid { display: flex; flex-direction: column; gap: 15px; }
        .track-card { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; display: grid; grid-template-columns: 60px 1fr auto auto; gap: 20px; align-items: center; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; }
        .track-card:hover { border-color: rgba(34,197,94,0.5); background: rgba(255,255,255,0.08); }
        .play-btn { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; color: white; font-size: 1.5em; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .play-btn:hover { transform: scale(1.1); }
        .track-info h3 { font-size: 1.1em; margin-bottom: 5px; }
        .track-meta { color: rgba(255,255,255,0.5); font-size: 0.9em; }
        .track-meta span { margin-right: 15px; }
        .track-artist { color: #22c55e; }
        .track-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 12px; font-size: 0.8em; color: rgba(255,255,255,0.7); }
        .license-options { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
        .license-btn { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9em; }
        .license-btn.primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .license-btn.secondary { background: rgba(255,255,255,0.1); color: white; }
        .price-tag { color: #22c55e; font-weight: bold; font-size: 1.1em; }
        .upload-cta { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(22,163,74,0.1)); border: 2px dashed rgba(34,197,94,0.5); border-radius: 20px; padding: 50px; text-align: center; margin-top: 40px; }
        .upload-cta h3 { margin-bottom: 10px; }
        .upload-cta p { color: rgba(255,255,255,0.6); margin-bottom: 20px; }
        .btn { display: inline-block; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 15px 30px; border-radius: 25px; text-decoration: none; font-weight: 600; }
        .empty-state { text-align: center; padding: 80px; color: rgba(255,255,255,0.5); }
        .empty-state .icon { font-size: 4em; margin-bottom: 20px; }
        .audio-player { position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 15px 40px; display: none; align-items: center; gap: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .audio-player.active { display: flex; }
        .player-info { flex: 1; }
        .player-info h4 { font-size: 1em; margin-bottom: 3px; }
        .player-info p { color: rgba(255,255,255,0.5); font-size: 0.85em; }
        .player-controls { display: flex; gap: 15px; align-items: center; }
        .player-controls button { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .progress-bar { flex: 2; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; cursor: pointer; }
        .progress-bar .progress { height: 100%; background: #22c55e; border-radius: 3px; width: 0%; }
        @media (max-width: 768px) { .track-card { grid-template-columns: 50px 1fr; } .license-options { display: none; } }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">üé¨ <span>PACCS</span></a>
        <nav class="nav-links">
            <a href="/watch">Films</a>
            <a href="/music-browse" style="background: rgba(34,197,94,0.2); color: #22c55e;">Music</a>
            <a href="/dashboard">Dashboard</a>
        </nav>
    </header>
    
    <section class="hero">
        <h1>üéµ Music <span>Marketplace</span></h1>
        <p>License amazing music for your films. All tracks cleared for film use. Artists earn 70% of every license.</p>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search by mood, genre, or artist..." onkeypress="if(event.key==='Enter')searchTracks()">
            <button onclick="searchTracks()">üîç Search</button>
        </div>
        <div class="filters">
            <button class="filter-btn active" onclick="filterByMood('all')">All</button>
            <button class="filter-btn" onclick="filterByMood('upbeat')">Upbeat</button>
            <button class="filter-btn" onclick="filterByMood('dramatic')">Dramatic</button>
            <button class="filter-btn" onclick="filterByMood('ambient')">Ambient</button>
            <button class="filter-btn" onclick="filterByMood('emotional')">Emotional</button>
            <button class="filter-btn" onclick="filterByMood('action')">Action</button>
        </div>
    </section>
    
    <main class="main-content">
        <div class="section-header">
            <h2>üéß Available Tracks</h2>
            <span id="trackCount">Loading...</span>
        </div>
        
        <div class="tracks-grid" id="tracksGrid"></div>
        
        <section class="upload-cta">
            <h3>üé∏ Are You a Musician?</h3>
            <p>Upload your music and earn 70% of every license. Reach filmmakers worldwide.</p>
            <a href="/music-upload" class="btn">Upload Your Music ‚Üí</a>
        </section>
    </main>
    
    <div class="audio-player" id="audioPlayer">
        <button onclick="togglePlay()" id="playerPlayBtn">‚è∏Ô∏è</button>
        <div class="player-info">
            <h4 id="playerTitle">Track Name</h4>
            <p id="playerArtist">Artist Name</p>
        </div>
        <div class="progress-bar" onclick="seek(event)">
            <div class="progress" id="playerProgress"></div>
        </div>
        <span id="playerTime">0:00 / 0:00</span>
        <button onclick="closePlayer()">‚úï</button>
    </div>
    
    <audio id="audio"></audio>
    
    <script>
        var allTracks = [];
        var currentTrack = null;
        var audio = document.getElementById('audio');
        var user = null;
        try { user = JSON.parse(localStorage.getItem('paccs_user')); } catch(e) {}
        
        function loadTracks() {
            fetch('/api/music/tracks')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    allTracks = data.tracks || [];
                    renderTracks(allTracks);
                })
                .catch(function(e) {
                    console.error(e);
                    showEmpty();
                });
        }
        
        function renderTracks(tracks) {
            var grid = document.getElementById('tracksGrid');
            document.getElementById('trackCount').textContent = tracks.length + ' tracks';
            
            if (tracks.length === 0) {
                showEmpty();
                return;
            }
            
            var html = '';
            for (var i = 0; i < tracks.length; i++) {
                var t = tracks[i];
                html += '<div class="track-card">';
                html += '<button class="play-btn" onclick="playTrack(\'' + t.id + '\')">‚ñ∂</button>';
                html += '<div class="track-info">';
                html += '<h3>' + t.title + '</h3>';
                html += '<div class="track-meta">';
                html += '<span class="track-artist">üé§ ' + (t.artist || 'Unknown Artist') + '</span>';
                html += '<span>üéµ ' + (t.genre || 'Music') + '</span>';
                html += '<span>‚è± ' + (t.duration || '3:00') + '</span>';
                html += '</div>';
                html += '<div class="track-tags">';
                var moods = t.moods || [];
                for (var j = 0; j < moods.length; j++) {
                    html += '<span class="tag">' + moods[j] + '</span>';
                }
                html += '</div></div>';
                html += '<div class="license-options">';
                html += '<span class="price-tag">From ¬£' + (t.price_short || 15) + '</span>';
                html += '<button class="license-btn primary" onclick="licenseTrack(\'' + t.id + '\')">License</button>';
                html += '</div>';
                html += '</div>';
            }
            grid.innerHTML = html;
        }
        
        function showEmpty() {
            document.getElementById('tracksGrid').innerHTML = '<div class="empty-state"><div class="icon">üéµ</div><h3>No Tracks Yet</h3><p>Be the first to upload your music!</p><a href="/music-upload" class="btn" style="margin-top:20px;">Upload Music</a></div>';
            document.getElementById('trackCount').textContent = '0 tracks';
        }
        
        function searchTracks() {
            var q = document.getElementById('searchInput').value.toLowerCase();
            if (!q) {
                renderTracks(allTracks);
                return;
            }
            var filtered = allTracks.filter(function(t) {
                return t.title.toLowerCase().indexOf(q) >= 0 || 
                       (t.artist || '').toLowerCase().indexOf(q) >= 0 ||
                       (t.genre || '').toLowerCase().indexOf(q) >= 0;
            });
            renderTracks(filtered);
        }
        
        function filterByMood(mood) {
            document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
            event.target.classList.add('active');
            
            if (mood === 'all') {
                renderTracks(allTracks);
                return;
            }
            var filtered = allTracks.filter(function(t) {
                var moods = t.moods || [];
                for (var i = 0; i < moods.length; i++) {
                    if (moods[i].toLowerCase() === mood) return true;
                }
                return false;
            });
            renderTracks(filtered);
        }
        
        function playTrack(id) {
            var track = allTracks.find(function(t) { return t.id === id; });
            if (!track || !track.audio_url) {
                alert('Preview not available');
                return;
            }
            currentTrack = track;
            audio.src = track.audio_url;
            audio.play();
            document.getElementById('audioPlayer').classList.add('active');
            document.getElementById('playerTitle').textContent = track.title;
            document.getElementById('playerArtist').textContent = track.artist || 'Unknown Artist';
            document.getElementById('playerPlayBtn').textContent = '‚è∏Ô∏è';
        }
        
        function togglePlay() {
            if (audio.paused) {
                audio.play();
                document.getElementById('playerPlayBtn').textContent = '‚è∏Ô∏è';
            } else {
                audio.pause();
                document.getElementById('playerPlayBtn').textContent = '‚ñ∂Ô∏è';
            }
        }
        
        function closePlayer() {
            audio.pause();
            document.getElementById('audioPlayer').classList.remove('active');
        }
        
        audio.addEventListener('timeupdate', function() {
            var progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('playerProgress').style.width = progress + '%';
            var current = formatTime(audio.currentTime);
            var total = formatTime(audio.duration);
            document.getElementById('playerTime').textContent = current + ' / ' + total;
        });
        
        function formatTime(s) {
            if (isNaN(s)) return '0:00';
            var m = Math.floor(s / 60);
            var sec = Math.floor(s % 60);
            return m + ':' + (sec < 10 ? '0' : '') + sec;
        }
        
        function seek(e) {
            var bar = e.target;
            var percent = e.offsetX / bar.offsetWidth;
            audio.currentTime = percent * audio.duration;
        }
        
        function licenseTrack(id) {
            if (!user) {
                window.location = '/login?redirect=/music-browse';
                return;
            }
            window.location = '/music-license/' + id;
        }
        
        loadTracks();
    </script>
</body>
</html>