<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Track - PACCS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5em; font-weight: bold; color: #fff; text-decoration: none; }
        .logo span { color: #a855f7; }
        .nav-links a { color: rgba(255,255,255,0.8); text-decoration: none; padding: 8px 16px; margin-left: 10px; }
        .main { max-width: 900px; margin: 0 auto; padding: 40px; }
        .back-link { color: #22c55e; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 30px; }
        .track-header { display: grid; grid-template-columns: 120px 1fr; gap: 30px; margin-bottom: 40px; }
        .track-art { width: 120px; height: 120px; background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 3em; }
        .track-info h1 { font-size: 2em; margin-bottom: 10px; }
        .track-meta { color: rgba(255,255,255,0.6); margin-bottom: 15px; }
        .track-meta span { margin-right: 20px; }
        .track-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { background: rgba(34,197,94,0.2); color: #22c55e; padding: 5px 15px; border-radius: 15px; font-size: 0.85em; }
        .player-section { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px; margin-bottom: 40px; display: flex; align-items: center; gap: 20px; }
        .play-btn { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .progress-container { flex: 1; }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; margin-bottom: 8px; }
        .progress-bar .progress { height: 100%; background: #22c55e; border-radius: 4px; width: 0%; transition: width 0.1s; }
        .time-display { display: flex; justify-content: space-between; color: rgba(255,255,255,0.5); font-size: 0.85em; }
        .license-section h2 { margin-bottom: 25px; }
        .license-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .license-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .license-card:hover { border-color: rgba(34,197,94,0.5); }
        .license-card.selected { border-color: #22c55e; background: rgba(34,197,94,0.1); }
        .license-card .type { font-size: 1.2em; font-weight: 600; margin-bottom: 10px; }
        .license-card .price { font-size: 2.5em; font-weight: bold; color: #22c55e; margin-bottom: 10px; }
        .license-card .desc { color: rgba(255,255,255,0.5); font-size: 0.9em; line-height: 1.5; }
        .license-card ul { text-align: left; margin-top: 15px; color: rgba(255,255,255,0.7); font-size: 0.85em; }
        .license-card li { margin-bottom: 8px; padding-left: 20px; position: relative; }
        .license-card li::before { content: "‚úì"; color: #22c55e; position: absolute; left: 0; }
        .purchase-btn { display: block; width: 100%; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 18px; border-radius: 30px; border: none; font-size: 1.2em; font-weight: 600; cursor: pointer; margin-top: 20px; }
        .purchase-btn:hover { box-shadow: 0 10px 30px rgba(34,197,94,0.4); }
        .purchase-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .artist-card { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px; margin-top: 40px; display: flex; align-items: center; gap: 20px; }
        .artist-avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #22c55e, #16a34a); display: flex; align-items: center; justify-content: center; font-size: 1.5em; }
        .artist-info h3 { margin-bottom: 5px; }
        .artist-info p { color: #22c55e; }
        .loading { text-align: center; padding: 100px; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.2); border-top-color: #22c55e; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { .license-options { grid-template-columns: 1fr; } .track-header { grid-template-columns: 1fr; text-align: center; } .track-art { margin: 0 auto; } }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">üé¨ <span>PACCS</span></a>
        <nav class="nav-links">
            <a href="/music-browse">Browse Music</a>
            <a href="/dashboard">Dashboard</a>
        </nav>
    </header>
    
    <main class="main" id="main">
        <div class="loading"><div class="spinner"></div><p>Loading track...</p></div>
    </main>
    
    <audio id="audio"></audio>
    
    <script>
        var trackId = window.location.pathname.split('/').pop();
        var user = null;
        try { user = JSON.parse(localStorage.getItem('paccs_user')); } catch(e) {}
        var track = null;
        var selectedLicense = 'short';
        var audio = document.getElementById('audio');
        var isPlaying = false;
        
        function loadTrack() {
            fetch('/api/music/track/' + trackId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        track = data.track;
                        renderPage();
                    } else {
                        showError();
                    }
                })
                .catch(function(e) {
                    console.error(e);
                    showError();
                });
        }
        
        function renderPage() {
            var moods = track.moods || [];
            var moodTags = '';
            for (var i = 0; i < moods.length; i++) {
                moodTags += '<span class="tag">' + moods[i] + '</span>';
            }
            
            var html = '<a href="/music-browse" class="back-link">‚Üê Back to Music</a>';
            html += '<div class="track-header">';
            html += '<div class="track-art">üéµ</div>';
            html += '<div class="track-info">';
            html += '<h1>' + track.title + '</h1>';
            html += '<div class="track-meta"><span>üé§ ' + (track.artist || 'Unknown Artist') + '</span><span>üéµ ' + (track.genre || 'Music') + '</span><span>‚è± ' + (track.duration || '3:00') + '</span></div>';
            html += '<div class="track-tags">' + moodTags + '</div>';
            html += '</div></div>';
            
            html += '<div class="player-section">';
            html += '<button class="play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>';
            html += '<div class="progress-container">';
            html += '<div class="progress-bar" onclick="seek(event)"><div class="progress" id="progress"></div></div>';
            html += '<div class="time-display"><span id="currentTime">0:00</span><span id="totalTime">' + (track.duration || '3:00') + '</span></div>';
            html += '</div></div>';
            
            html += '<section class="license-section"><h2>Choose License Type</h2>';
            html += '<div class="license-options">';
            html += '<div class="license-card selected" id="card-short" onclick="selectLicense(\'short\')">';
            html += '<div class="type">Short Film</div><div class="price">¬£' + (track.price_short || 15) + '</div>';
            html += '<div class="desc">For films under 40 minutes</div>';
            html += '<ul><li>Non-exclusive license</li><li>Festival & online use</li><li>Perpetual rights</li></ul></div>';
            html += '<div class="license-card" id="card-feature" onclick="selectLicense(\'feature\')">';
            html += '<div class="type">Feature Film</div><div class="price">¬£' + (track.price_feature || 50) + '</div>';
            html += '<div class="desc">For films over 40 minutes</div>';
            html += '<ul><li>Non-exclusive license</li><li>Theatrical & streaming</li><li>Perpetual rights</li></ul></div>';
            html += '<div class="license-card" id="card-commercial" onclick="selectLicense(\'commercial\')">';
            html += '<div class="type">Commercial</div><div class="price">¬£' + (track.price_commercial || 100) + '</div>';
            html += '<div class="desc">For ads & branded content</div>';
            html += '<ul><li>Non-exclusive license</li><li>Broadcast & digital ads</li><li>1 year term</li></ul></div>';
            html += '</div>';
            html += '<button class="purchase-btn" id="purchaseBtn" onclick="purchaseLicense()">Purchase License - ¬£' + (track.price_short || 15) + '</button>';
            html += '</section>';
            
            html += '<div class="artist-card">';
            html += '<div class="artist-avatar">' + (track.artist ? track.artist[0].toUpperCase() : 'üé§') + '</div>';
            html += '<div class="artist-info"><h3>' + (track.artist || 'Unknown Artist') + '</h3><p>Musician</p></div></div>';
            
            document.getElementById('main').innerHTML = html;
            
            if (track.audio_url) {
                audio.src = track.audio_url;
            }
        }
        
        function selectLicense(type) {
            selectedLicense = type;
            document.querySelectorAll('.license-card').forEach(function(c) { c.classList.remove('selected'); });
            document.getElementById('card-' + type).classList.add('selected');
            
            var price = type === 'short' ? (track.price_short || 15) : type === 'feature' ? (track.price_feature || 50) : (track.price_commercial || 100);
            document.getElementById('purchaseBtn').textContent = 'Purchase License - ¬£' + price;
        }
        
        function togglePlay() {
            if (!track.audio_url) {
                alert('Audio preview not available');
                return;
            }
            if (isPlaying) {
                audio.pause();
                document.getElementById('playBtn').textContent = '‚ñ∂';
            } else {
                audio.play();
                document.getElementById('playBtn').textContent = '‚è∏';
            }
            isPlaying = !isPlaying;
        }
        
        audio.addEventListener('timeupdate', function() {
            var progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progress').style.width = progress + '%';
            document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
        });
        
        audio.addEventListener('ended', function() {
            isPlaying = false;
            document.getElementById('playBtn').textContent = '‚ñ∂';
        });
        
        function formatTime(s) {
            if (isNaN(s)) return '0:00';
            var m = Math.floor(s / 60);
            var sec = Math.floor(s % 60);
            return m + ':' + (sec < 10 ? '0' : '') + sec;
        }
        
        function seek(e) {
            var bar = e.target;
            if (bar.className === 'progress') bar = bar.parentElement;
            var percent = e.offsetX / bar.offsetWidth;
            audio.currentTime = percent * audio.duration;
        }
        
        function purchaseLicense() {
            if (!user) {
                window.location = '/login?redirect=/music-license/' + trackId;
                return;
            }
            
            var btn = document.getElementById('purchaseBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            var price = selectedLicense === 'short' ? (track.price_short || 15) : selectedLicense === 'feature' ? (track.price_feature || 50) : (track.price_commercial || 100);
            
            fetch('/api/music/license', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    track_id: trackId,
                    license_type: selectedLicense,
                    price: price,
                    email: user.email
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.url) {
                    window.location = data.url;
                } else {
                    alert(data.error || 'Error processing payment');
                    btn.disabled = false;
                    btn.textContent = 'Purchase License - ¬£' + price;
                }
            })
            .catch(function(e) {
                alert('Error: ' + e.message);
                btn.disabled = false;
            });
        }
        
        function showError() {
            document.getElementById('main').innerHTML = '<div style="text-align:center;padding:100px;"><h2>Track Not Found</h2><a href="/music-browse" style="color:#22c55e;">Browse Music</a></div>';
        }
        
        loadTrack();
    </script>
</body>
</html>